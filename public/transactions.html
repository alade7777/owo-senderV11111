<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="transactionsTitle">Transactions - OWO-SENDER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            padding-top: 20px; /* Réduction du padding-top car nous n'avons plus de navbar fixe */
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .page-title {
            margin-bottom: 2rem;
        }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            background: white !important;
            height: 80px; /* Hauteur fixe pour la navbar */
        }
        .container.mt-5 {
            margin-top: 2rem !important; /* Réduction de la marge supérieure du conteneur */
        }
        .page-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 3rem;
            border-radius: 0 0 20px 20px;
            position: relative;
            z-index: 1;
        }
        .page-header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .transaction-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        .transaction-card:hover {
            transform: translateY(-5px);
        }
        .transaction-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .transaction-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        .transaction-details p {
            margin-bottom: 0.5rem;
            color: #666;
        }
        .transaction-details strong {
            color: #333;
        }
        .transaction-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .transaction-date {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .transaction-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .filter-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .filter-section .form-control {
            border-radius: 20px;
        }
        .filter-section .btn {
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
        }

        /* Styles pour le mode sombre */
        body.dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        body.dark .navbar {
            background-color: #2d2d2d !important;
            border-color: #404040;
        }

        body.dark .navbar-light .btn-outline-primary {
            color: #ffffff;
            border-color: #ffffff;
        }

        body.dark .navbar-light .btn-outline-primary:hover {
            background-color: #ffffff;
            color: #1a1a1a;
        }

        body.dark .transaction-card,
        body.dark .filter-card,
        body.dark .stats-card {
            background-color: #2d2d2d;
            border-color: #404040;
        }

        body.dark .table {
            color: #ffffff;
        }

        body.dark .table thead th {
            border-bottom-color: #404040;
        }

        body.dark .table td {
            border-top-color: #404040;
        }

        body.dark .text-muted {
            color: #a0a0a0 !important;
        }

        body.dark .form-control,
        body.dark .form-select {
            background-color: #404040;
            border-color: #505050;
            color: #ffffff;
        }

        body.dark .form-control:focus,
        body.dark .form-select:focus {
            background-color: #404040;
            border-color: #0d6efd;
            color: #ffffff;
        }

        body.dark .form-label {
            color: #ffffff;
        }

        body.dark .transaction-icon {
            background-color: #404040;
        }

        body.dark .btn-view {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #ffffff;
        }

        body.dark .btn-view:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }

        body.dark .page-title {
            color: #ffffff;
        }

        body.dark .stats-card {
            background-color: #2d2d2d;
            border: 1px solid #404040;
        }

        body.dark .stats-card .number {
            color: #ffffff;
        }

        body.dark .stats-card .icon {
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <a href="index.html" class="btn btn-outline-primary rounded-pill">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="back">Retour</span>
            </a>
            <div class="dropdown">
                <div id="userAvatar" class="user-avatar" data-bs-toggle="dropdown" aria-expanded="false"></div>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAvatar">
                    <li><a class="dropdown-item" href="profil.html"><i class="fas fa-user me-2"></i><span data-i18n="profile">Profil</span></a></li>
                    <li><a class="dropdown-item" href="transactions.html"><i class="fas fa-history me-2"></i><span data-i18n="transactions">Transactions</span></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i><span data-i18n="logout">Déconnexion</span></a></li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h2 class="page-title">
                    <i class="fas fa-history me-2"></i><span data-i18n="myTransactions">Mes Transactions</span>
                </h2>

                <!-- Statistiques -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card p-4">
                            <div class="d-flex align-items-center">
                                <div class="icon me-3">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div>
                                    <div class="number" id="completedCount">0</div>
                                    <div class="text-muted" data-i18n="completedTransactions">Transactions complétées</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card p-4">
                            <div class="d-flex align-items-center">
                                <div class="icon me-3">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <div class="number" id="totalAmount">0 FCFA</div>
                                    <div class="text-muted" data-i18n="totalAmount">Montant total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card p-4">
                            <div class="d-flex align-items-center">
                                <div class="icon me-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <div class="number" id="pendingCount">0</div>
                                    <div class="text-muted" data-i18n="pendingTransactions">En attente</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtres -->
                <div class="filter-card">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="fas fa-filter me-2"></i><span data-i18n="status">Statut</span></label>
                            <select class="form-select" id="statusFilter">
                                <option value="all" data-i18n="all">Tous</option>
                                <option value="completed" data-i18n="completed">Complétées</option>
                                <option value="pending" data-i18n="pending">En attente</option>
                                <option value="failed" data-i18n="failed">Échouées</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="fas fa-calendar me-2"></i><span data-i18n="date">Date</span></label>
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="fas fa-money-bill me-2"></i><span data-i18n="amount">Montant</span></label>
                            <input type="number" class="form-control" id="amountFilter" data-i18n-placeholder="minAmount" placeholder="Montant minimum">
                        </div>
                    </div>
                </div>

                <!-- Liste des transactions -->
                <div class="transaction-card">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th data-i18n="transactionId">Transaction</th>
                                    <th data-i18n="date">Date</th>
                                    <th data-i18n="recipient">Destinataire</th>
                                    <th data-i18n="amount">Montant</th>
                                    <th data-i18n="status">Statut</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList">
                                <!-- Les transactions seront ajoutées ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="dark-mode.js"></script>
    <script src="lang.js"></script>
    <script>
        // Vérification du mode sombre
        const isDark = localStorage.getItem("theme") === "dark";
        if (isDark) {
            document.body.classList.add("dark");
        }

        // Vérification de l'authentification
        const email = localStorage.getItem("userEmail");
        if (!email) {
            window.location.href = "connexion.html";
        }

        // Initialisation de l'avatar
        const name = localStorage.getItem("userName");
        const avatar = document.getElementById("userAvatar");
        avatar.textContent = name?.trim().charAt(0).toUpperCase() || "?";

        // Gestion de la déconnexion
        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("userName");
            localStorage.removeItem("userEmail");
            window.location.href = "index.html";
        });

        // Fonction pour mettre à jour les statistiques
        function updateStats(transactions) {
            const completed = transactions.filter(t => t.status === 'completed').length;
            const pending = transactions.filter(t => t.status === 'pending').length;
            const totalAmount = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' FCFA';
        }

        // Écouter les mises à jour des transactions
        window.addEventListener('transactionUpdated', (event) => {
            const { transactionId, newStatus, updatedAt } = event.detail;
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const transactionIndex = transactions.findIndex(t => t.id === transactionId);
            
            if (transactionIndex !== -1) {
                transactions[transactionIndex].status = newStatus;
                transactions[transactionIndex].updatedAt = updatedAt;
                localStorage.setItem('transactions', JSON.stringify(transactions));
                loadTransactions(); // Recharger l'affichage
            }
        });

        // Fonction pour charger les transactions
        function loadTransactions() {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';

            // Filtrer les transactions de l'utilisateur connecté
            const userTransactions = transactions.filter(transaction => 
                transaction.senderEmail === email || transaction.recipientEmail === email
            );

            // Mettre à jour les statistiques avec uniquement les transactions de l'utilisateur
            updateStats(userTransactions);

            // Appliquer les filtres
            const status = document.getElementById('statusFilter').value;
            const date = document.getElementById('dateFilter').value;
            const amount = document.getElementById('amountFilter').value;

            const filteredTransactions = userTransactions.filter(transaction => {
                const matchesStatus = status === 'all' || transaction.status === status;
                const matchesDate = !date || transaction.date.startsWith(date);
                const matchesAmount = !amount || transaction.amount >= parseInt(amount);

                return matchesStatus && matchesDate && matchesAmount;
            });

            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                const isSender = transaction.senderEmail === email;
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="transaction-icon ${isSender ? 'sent' : 'received'}">
                                <i class="fas ${isSender ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${transaction.id}</div>
                                <small class="text-muted" data-i18n="${isSender ? 'sent' : 'received'}">${isSender ? 'Envoi' : 'Réception'}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold">${new Date(transaction.date).toLocaleDateString()}</div>
                        <small class="text-muted">${new Date(transaction.date).toLocaleTimeString()}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${isSender ? transaction.recipient : transaction.sender}</div>
                        <small class="text-muted">${isSender ? transaction.recipientPhone : transaction.senderEmail}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${transaction.amount.toLocaleString()} FCFA</div>
                        <small class="text-muted" data-i18n="fees">Frais: ${(transaction.fees || 0).toLocaleString()} FCFA</small>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(transaction.status)}">
                            ${getStatusText(transaction.status)}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-view btn-primary" onclick="viewTransactionDetails(event, '${transaction.id}')">
                            <i class="fas fa-eye me-1"></i> <span data-i18n="viewDetails">Détails</span>
                        </button>
                    </td>
                `;
                transactionsList.appendChild(row);
            });
        }

        // Fonction pour obtenir la classe CSS du badge selon le statut
        function getStatusBadgeClass(status) {
            switch(status.toLowerCase()) {
                case 'completed':
                    return 'bg-success';
                case 'pending':
                    return 'bg-warning';
                case 'failed':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        // Fonction pour obtenir le texte du statut
        function getStatusText(status) {
            switch(status.toLowerCase()) {
                case 'completed':
                    return 'Complétée';
                case 'pending':
                    return 'En attente';
                case 'failed':
                    return 'Échouée';
                default:
                    return status;
            }
        }

        // Fonction pour voir les détails d'une transaction
        function viewTransactionDetails(event, id) {
            event.preventDefault();
            event.stopPropagation();
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const transaction = transactions.find(t => t.id === id);
            
            if (transaction && (transaction.senderEmail === email || transaction.recipientEmail === email)) {
                const isSender = transaction.senderEmail === email;
                alert(`
                    Détails de la transaction:
                    ID: ${transaction.id}
                    Date: ${new Date(transaction.date).toLocaleString()}
                    Type: ${isSender ? 'Envoi' : 'Réception'}
                    ${isSender ? 'Destinataire' : 'Expéditeur'}: ${isSender ? transaction.recipient : transaction.sender}
                    ${isSender ? 'Tél. Destinataire' : 'Email Expéditeur'}: ${isSender ? transaction.recipientPhone : transaction.senderEmail}
                    Montant: ${transaction.amount.toLocaleString()} FCFA
                    Frais: ${(transaction.fees || 0).toLocaleString()} FCFA
                    Statut: ${getStatusText(transaction.status)}
                    ${transaction.updatedAt ? `Dernière mise à jour: ${new Date(transaction.updatedAt).toLocaleString()}` : ''}
                `);
            }
        }

        // Gestion des filtres
        document.getElementById('statusFilter').addEventListener('change', loadTransactions);
        document.getElementById('dateFilter').addEventListener('change', loadTransactions);
        document.getElementById('amountFilter').addEventListener('input', loadTransactions);

        // Charger les transactions au chargement de la page
        loadTransactions();
    </script>
</body>
</html> 