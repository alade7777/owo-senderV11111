<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="sendTitle">Envoyer de l'argent - Transfert Mobile Money</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #555;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .back-btn svg {
      fill: none;
      stroke: #555;
      stroke-width: 2;
      transition: transform 0.2s ease;
    }

    .back-btn:hover svg {
      transform: translateX(-3px);
      stroke: #007bff;
    }

    .back-btn:hover {
      color: #007bff;
    }

    .btn-pill {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-weight: 500;
      transition: all 0.3s ease;
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
      animation: pulse 2s infinite;
    }

    .btn-pill:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
      animation: none;
    }

    .btn-pill:active {
      transform: translateY(1px);
    }

    .login-card {
      max-width: 500px;
      margin: 0 auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      animation: slideUp 0.5s ease-out;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .form-control,
    .form-select {
      border-radius: 50px;
      transition: all 0.3s ease;
      border: 2px solid #e9ecef;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
      transform: translateY(-1px);
    }

    .form-label {
      transition: all 0.3s ease;
      color: #495057;
    }

    .form-control:focus + .form-label,
    .form-select:focus + .form-label {
      color: #007bff;
    }

    body {
      background-color: #f8f9fa;
      background-image: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Animation pour les champs du formulaire */
    .mb-3 {
      animation: fadeIn 0.5s ease-out forwards;
      opacity: 0;
    }

    .mb-3:nth-child(1) { animation-delay: 0.1s; }
    .mb-3:nth-child(2) { animation-delay: 0.2s; }
    .mb-3:nth-child(3) { animation-delay: 0.3s; }
    .mb-3:nth-child(4) { animation-delay: 0.4s; }
    .mb-3:nth-child(5) { animation-delay: 0.5s; }
    .mb-3:nth-child(6) { animation-delay: 0.6s; }
    .mb-3:nth-child(7) { animation-delay: 0.7s; }
    .mb-3:nth-child(8) { animation-delay: 0.8s; }
    .mb-3:nth-child(9) { animation-delay: 0.9s; }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Animation pour le toast */
    .toast {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Animation du bouton "Envoyer maintenant" */
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
      }
      70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
      }
    }
  </style>
</head>
<body class="login-page">

  <!-- Formulaire d'envoi -->
  <div class="login-card mt-4">
    <!-- Bouton Retour -->
    <div class="text-start mb-3">
      <a href="index.html" class="back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span data-i18n="back">Retour</span>
      </a>
    </div>

    <h2 class="mb-4 text-center" data-i18n="formTitle">Transfert Mobile Money</h2>
    <form id="sendForm">
      <div class="mb-3">
        <label for="envoyeurNom" class="form-label" data-i18n="senderNameLabel">Nom de l'envoyeur</label>
        <input type="text" id="envoyeurNom" class="form-control" data-i18n-placeholder="senderNamePlaceholder" required />
      </div>

      <div class="mb-3">
        <label for="envoyeurNumero" class="form-label" data-i18n="senderPhoneLabel">NumÃ©ro de l'envoyeur</label>
        <input type="tel" id="envoyeurNumero" class="form-control" data-i18n-placeholder="senderPhonePlaceholder" required />
      </div>

      <div class="mb-3">
        <label for="pays" class="form-label" data-i18n="countryLabel">Pays de destination</label>
        <select id="pays" class="form-select" required>
          <option value="" data-i18n="selectCountry">SÃ©lectionner un pays</option>
          <option value="BÃ©nin" data-i18n="benin">ðŸ‡§ðŸ‡¯ BÃ©nin</option>
          <option value="Congo" data-i18n="congo">ðŸ‡¨ðŸ‡¬ Congo</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="montant" class="form-label" data-i18n="amountLabel">Montant Ã  envoyer</label>
        <input type="number" id="montant" class="form-control" data-i18n-placeholder="amountPlaceholder" required />
      </div>

      <div class="mb-3">
        <label for="total" class="form-label" data-i18n="totalLabel">Total Ã  payer (frais inclus)</label>
        <input type="text" id="total" class="form-control" value="0 FCFA" disabled />
      </div>

      <div class="mb-3">
        <label for="operateur" class="form-label" data-i18n="operatorLabel">OpÃ©rateur Mobile</label>
        <select id="operateur" class="form-select" required>
          <option value="" data-i18n="selectOperator">Choisir un opÃ©rateur</option>
          <option value="MTN" data-i18n="mtn">MTN</option>
          <option value="Moov" data-i18n="moov">Moov</option>
          <option value="Airtel" data-i18n="airtel">Airtel</option>
          <option value="Orange" data-i18n="orange">Orange</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="numero" class="form-label" data-i18n="phoneLabel">NumÃ©ro du destinataire</label>
        <input type="tel" id="numero" class="form-control" data-i18n-placeholder="phonePlaceholder" required />
      </div>

      <div class="mb-3">
        <label for="nom" class="form-label" data-i18n="nameLabel">Nom du destinataire</label>
        <input type="text" id="nom" class="form-control" data-i18n-placeholder="namePlaceholder" required />
      </div>

      <div class="mb-3">
        <label for="message" class="form-label" data-i18n="messageLabel">Message (optionnel)</label>
        <textarea id="message" class="form-control" data-i18n-placeholder="messagePlaceholder" rows="3"></textarea>
      </div>

      <div class="d-grid">
        <button type="submit" class="btn-pill" data-i18n="sendNow">Envoyer maintenant</button>
      </div>
    </form>
  </div>

  <!-- Toast succÃ¨s -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastSuccess" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" data-i18n="sendSuccess">Transfert effectuÃ© avec succÃ¨s !</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="script.js"></script>
  <script src="lang.js"></script>
  <script src="dark-mode.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // VÃ©rification simple de la connexion
    if (!localStorage.getItem("userEmail")) {
      window.location.href = "connexion.html";
    }

    // PrÃ©-remplir les informations de l'envoyeur
    const userName = localStorage.getItem("userName");
    const userPhone = localStorage.getItem("userPhone");
    const userCountry = localStorage.getItem("userCountry");

    if (userName) {
      document.getElementById("envoyeurNom").value = userName;
    }
    if (userPhone) {
      document.getElementById("envoyeurNumero").value = userPhone;
    } else {
      // Le numÃ©ro de l'envoyeur est toujours Congo
      document.getElementById("envoyeurNumero").value = "+242";
    }
    if (userCountry) {
      document.getElementById("pays").value = userCountry;
    }

    const montantInput = document.getElementById("montant");
    const totalInput = document.getElementById("total");

    montantInput.addEventListener("input", () => {
      const montant = parseFloat(montantInput.value);
      if (!isNaN(montant) && montant > 0) {
        const frais = Math.ceil(montant * 0.1);
        const total = montant + frais;
        totalInput.value = `${total} FCFA`;
        totalInput.dataset.total = total;
      } else {
        totalInput.value = "0 FCFA";
        totalInput.dataset.total = 0;
      }
    });

    // Fonction de validation du numÃ©ro de tÃ©lÃ©phone
    function validatePhoneNumber(phone, country) {
      const phoneRegex = {
        'BÃ©nin': /^(\+229|229)?[0-9]{8}$/,
        'Congo': /^(\+242|242)?[0-9]{9}$/
      };
      
      // Nettoyer le numÃ©ro
      const cleanPhone = phone.replace(/\s+/g, '');
      
      // VÃ©rifier le format selon le pays
      return phoneRegex[country]?.test(cleanPhone) || false;
    }

    // Fonction pour formater le numÃ©ro de tÃ©lÃ©phone
    function formatPhoneNumber(phone, country) {
      const cleanPhone = phone.replace(/\s+/g, '');
      if (country === 'BÃ©nin') {
        return cleanPhone.startsWith('+229') ? cleanPhone : 
               cleanPhone.startsWith('229') ? `+${cleanPhone}` : 
               `+229${cleanPhone}`;
      } else if (country === 'Congo') {
        return cleanPhone.startsWith('+242') ? cleanPhone : 
               cleanPhone.startsWith('242') ? `+${cleanPhone}` : 
               `+242${cleanPhone}`;
      }
      return cleanPhone;
    }

    const sendForm = document.getElementById("sendForm");
    if (sendForm) {
      sendForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        // VÃ©rifier que tous les champs requis sont remplis
        const requiredFields = ['envoyeurNom', 'envoyeurNumero', 'pays', 'montant', 'operateur', 'numero', 'nom'];
        const missingFields = requiredFields.filter(field => !document.getElementById(field)?.value);
        
        if (missingFields.length > 0) {
          alert("Veuillez remplir tous les champs obligatoires.");
          return;
        }

        const token = localStorage.getItem("token");
        const userEmail = localStorage.getItem("userEmail");
        const pays = document.getElementById("pays").value;
        const envoyeurNumero = document.getElementById("envoyeurNumero").value;
        const numero = document.getElementById("numero").value;

        // Validation du numÃ©ro de l'envoyeur (toujours Congo)
        if (!validatePhoneNumber(envoyeurNumero, 'Congo')) {
          alert("Le numÃ©ro de l'envoyeur doit Ãªtre un numÃ©ro congolais valide (format: +242XXXXXXXXX)");
          return;
        }

        // Validation du numÃ©ro du destinataire selon le pays
        if (!validatePhoneNumber(numero, pays)) {
          alert(`Le numÃ©ro du destinataire n'est pas valide pour ${pays}. Format attendu: ${pays === 'BÃ©nin' ? '+229XXXXXXXX' : '+242XXXXXXXXX'}`);
          return;
        }

        const payload = {
          pays: pays,
          montant: parseInt(document.getElementById("montant").value),
          total: parseInt(totalInput.dataset.total || 0),
          operateur: document.getElementById("operateur").value,
          numero: formatPhoneNumber(numero, pays),
          nom: document.getElementById("nom").value,
          message: document.getElementById("message")?.value || "",
          envoyeurNom: document.getElementById("envoyeurNom").value,
          envoyeurNumero: formatPhoneNumber(envoyeurNumero, 'Congo'), // Toujours Congo pour l'envoyeur
          userEmail: userEmail
        };

        console.log("DonnÃ©es envoyÃ©es:", payload);

        try {
          const API_URL = "https://owo-sender-backend.onrender.com/api/send";
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
              "X-User-Email": userEmail
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          console.log("RÃ©ponse du serveur:", data);

          if (res.ok) {
            const toast = document.getElementById("toastSuccess");
            const bsToast = new bootstrap.Toast(toast);
            toast.querySelector(".toast-body").textContent = data.message || "Transfert enregistrÃ© avec succÃ¨s.";
            bsToast.show();
            sendForm.reset();
            totalInput.value = "0 FCFA";
          } else {
            if (res.status === 401) {
              // Token invalide
              localStorage.removeItem("token");
              localStorage.removeItem("userEmail");
              localStorage.removeItem("userName");
              alert("Votre session a expirÃ©. Veuillez vous reconnecter.");
              window.location.href = "connexion.html";
            } else {
              alert(data.message || "Erreur lors de l'envoi. Veuillez rÃ©essayer.");
            }
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Une erreur est survenue. Veuillez rÃ©essayer.");
        }
      });
    }

    // ðŸŒ Langue
    const langSelect = document.getElementById("languageSelect");
    const savedLang = localStorage.getItem("lang") || "fr";
    langSelect.value = savedLang;
    updateLanguage(savedLang);

    langSelect.addEventListener("change", () => {
      const lang = langSelect.value;
      localStorage.setItem("lang", lang);
      updateLanguage(lang);
    });

    function updateLanguage(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (translations[lang] && translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (translations[lang] && translations[lang][key]) {
          el.setAttribute("placeholder", translations[lang][key]);
        }
      });
    }
  </script>
</body>
</html>
